<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Disclosure-Tracker | é‡å¤§è¨Šæ¯ç›£æ§ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { color: #333; border-left: 5px solid #007bff; padding-left: 10px; margin-top: 0; }
        
        /* æ­·å²è£œä»¶ç‹€æ…‹çœ‹æ¿æ¨£å¼ */
        .status-bar { 
            background: #343a40; color: #adff2f; padding: 10px 15px; border-radius: 8px; 
            margin-bottom: 20px; font-family: monospace; font-size: 13px; display: flex; 
            justify-content: space-between; align-items: center; box-shadow: inset 0 0 10px #000;
        }
        .status-item { margin-right: 20px; }
        .log-peek { color: #ddd; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 500px; }

        /* é€šçŸ¥åˆ—è¡¨æ¨£å¼ */
        #notif-section { border: 2px solid #ff4d4d; background-color: #fff9f9; }
        #notification-list { 
            list-style: none; padding: 0; max-height: 500px; overflow-y: auto; border: 1px solid #eee;
        }
        .notification-item:hover { background-color: #fff0f0; }
        .notif-tag {
            background: #ff4d4d; color: white; padding: 2px 8px; border-radius: 4px; 
            font-size: 12px; margin-right: 8px; font-weight: bold; display: inline-block; margin-bottom: 4px;
        }

        /* æ¨™ç±¤ç®¡ç†ä»‹é¢ */
        .kw-container {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 12px;
            border: 1px solid #ddd; border-radius: 4px; background: #fafafa;
            min-height: 45px; margin-bottom: 10px;
        }
        .kw-tag {
            background: #007bff; color: white; padding: 5px 12px; border-radius: 20px;
            display: flex; align-items: center; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .kw-tag .remove-btn { margin-left: 8px; cursor: pointer; color: #fff; font-weight: bold; opacity: 0.7; }
        .kw-tag .remove-btn:hover { opacity: 1; }
        
        .kw-input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        #kw-editor-panel { display: none; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }

        /* æŒ‰éˆ•èˆ‡æ§åˆ¶å€ */
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        input[type="text"], input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-query { background-color: #007bff; }
        .btn-export { background-color: #28a745; }
        .btn-save { background-color: #28a745; width: 100%; margin-top: 5px; }
        .btn-clear { background-color: #dc3545; font-size: 12px; }
        .btn-toggle-kw { background-color: #6c757d; font-size: 14px; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f1f3f5; position: sticky; top: 0; }
        td.content-cell { cursor: pointer; color: #007bff; text-decoration: underline; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        td.content-cell.expanded { white-space: normal; color: black; text-decoration: none; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: baseline;">
        <h2>ğŸ“ˆ è‚¡å¸‚é‡å¤§è¨Šæ¯ä¸»å‹•ç›£æ§ç³»çµ±</h2>
        <div id="time-display" style="font-size: 12px; color: #666;">ç³»çµ±æ™‚é–“: 2026/01/14</div>
    </div>

    <div class="status-bar" id="backfill-status-bar">
        <div>
            <span class="status-item">âš™ï¸ æ­·å²è£œä»¶é€²åº¦: <span id="backfill-info">è®€å–ä¸­...</span></span>
        </div>
        <div class="log-peek" id="log-peek">ç­‰å¾…æ—¥èªŒåŒæ­¥...</div>
    </div>

    <div id="notif-section" class="section" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ”” é—œéµå­—å‘½ä¸­é€šçŸ¥ (æœ€æ–° 20 ç­†)</h3>
            <button class="btn btn-clear" onclick="clearNotifications()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰é€šçŸ¥</button>
        </div>
        <div id="notification-list"></div>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ› ï¸ ç³»çµ±ç›£æ§è¨­å®š</h3>
            <button class="btn btn-toggle-kw" id="toggleKwBtn" onclick="toggleKwPanel()">âš™ï¸ ç·¨è¼¯ç›£æ§é—œéµå­—</button>
        </div>
        
        <div id="kw-editor-panel">
            <p style="font-size: 14px; color: #666;">æ–°å¢è³‡å®‰æˆ–é‡å¤§äº‹ä»¶é—œéµå­—ï¼Œå„²å­˜å¾Œå°‡ç«‹å³è§¸ç™¼èƒŒæ™¯æƒæã€‚</p>
            <div class="kw-input-group">
                <input type="text" id="new_kw_input" placeholder="è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enter (ä¾‹å¦‚: ç¶²è·¯æ”»æ“Š)">
                <button class="btn btn-query" onclick="addKeywordTag()">â• åŠ å…¥</button>
            </div>
            <div id="kw_list_tags" class="kw-container"></div>
            <button class="btn btn-save" onclick="saveServerKeywords()">ğŸ’¾ å„²å­˜ä¸¦æ›´æ–°ç›£æ§æ¸…å–®</button>
            <p id="save-status" style="margin-top: 8px; font-weight: bold;"></p>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ” æ­·å²è³‡æ–™æŸ¥è©¢</h3>
        <div class="controls">
            <label>æ—¥æœŸ: <input type="date" id="start_date"> ~ <input type="date" id="end_date"></label>
        </div>
        <div class="controls" style="margin-top: 10px;">
            <input type="text" id="search_company" placeholder="è¼¸å…¥å…¬å¸åç¨±æˆ–ä»£è™Ÿ (å¦‚: å°ç©é›»/2330)" style="flex: 1;">
            <input type="text" id="search_keyword" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: è³‡å®‰/é…æ¯)" style="flex: 1;">
            <button class="btn btn-query" onclick="fetchData()">åŸ·è¡ŒæŸ¥è©¢</button>
            <button id="exportBtn" class="btn btn-export" style="display:none;" onclick="exportToCSV()">åŒ¯å‡º CSV</button>
        </div>

        <table id="results">
            <thead>
                <tr>
                    <th>å¸‚å ´</th>
                    <th>å…¬å¸</th>
                    <th>æ—¥æœŸæ™‚é–“</th>
                    <th>ä¸»æ—¨</th>
                    <th>å…§æ–‡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let currentData = [];
    let activeKeywords = [];
    
    const currentHost = window.location.hostname;
    const API_BASE = `http://${currentHost}:8000`;

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("start_date").value = today;
        document.getElementById("end_date").value = today;
        loadServerKeywords();
        loadNotifications();
        
        // å•Ÿå‹•æ­·å²è£œä»¶é€²åº¦è¼ªè©¢ (æ¯ 5 ç§’)
        updateBackfillStatus();
        setInterval(updateBackfillStatus, 5000);
    };

    // --- æ­·å²è£œä»¶ç›£æ§é‚è¼¯ ---
    async function updateBackfillStatus() {
        try {
            // 1. æŠ“å–é€²åº¦ JSON
            const resStatus = await fetch(`${API_BASE}/backfill/status`);
            const prog = await resStatus.json();
            const infoSpan = document.getElementById("backfill-info");
            
            if (prog.current_year) {
                const marketName = prog.current_kind_idx === 0 ? "ä¸Šå¸‚" : "ä¸Šæ«ƒ";
                infoSpan.textContent = `${prog.current_year}å¹´ ${prog.current_month}æœˆ (${marketName}) - ç¬¬ ${prog.current_page} é `;
                infoSpan.style.color = "#adff2f";
            } else {
                infoSpan.textContent = "å·²å®Œæˆæˆ–æœªå•Ÿå‹•";
                infoSpan.style.color = "#888";
            }

            // 2. æŠ“å–æœ€æ–° Log
            const resLog = await fetch(`${API_BASE}/backfill/log?lines=1`);
            const logData = await resLog.json();
            const logPeek = document.getElementById("log-peek");
            if (logData.log) {
                const cleanLog = logData.log.trim().split('\n').pop(); // åªå–æœ€å¾Œä¸€è¡Œ
                logPeek.textContent = `æœ€æ–°å‹•ä½œ: ${cleanLog}`;
            }
        } catch (e) {
            document.getElementById("backfill-info").textContent = "é€£ç·šä¸­æ–·";
        }
    }

    // --- é¡¯ç¤º/éš±è— é¢æ¿é‚è¼¯ ---
    function toggleKwPanel() {
        const panel = document.getElementById("kw-editor-panel");
        const btn = document.getElementById("toggleKwBtn");
        if (panel.style.display === "none" || panel.style.display === "") {
            panel.style.display = "block";
            btn.textContent = "âœ–ï¸ é—œé–‰ç·¨è¼¯å™¨";
        } else {
            panel.style.display = "none";
            btn.textContent = "âš™ï¸ ç·¨è¼¯ç›£æ§é—œéµå­—";
        }
    }

    // --- é—œéµå­—ç®¡ç† ---
    async function loadServerKeywords() {
        try {
            const res = await fetch(`${API_BASE}/keywords`);
            const data = await res.json();
            if (data && data.keywords) {
                activeKeywords = data.keywords;
                renderKeywordTags();
            }
        } catch (e) { 
            console.error("ç„¡æ³•è¼‰å…¥é—œéµå­—", e); 
        }
    }

    function renderKeywordTags() {
        const container = document.getElementById("kw_list_tags");
        container.innerHTML = activeKeywords.length === 0 ? '<span style="color:#999">å°šæœªè¨­å®šç›£æ§é—œéµå­—</span>' : '';
        activeKeywords.forEach((kw, index) => {
            const tag = document.createElement("div");
            tag.className = "kw-tag";
            tag.innerHTML = `${kw}<span class="remove-btn" onclick="removeKeywordTag(${index})">Ã—</span>`;
            container.appendChild(tag);
        });
    }

    function addKeywordTag() {
        const input = document.getElementById("new_kw_input");
        const val = input.value.trim();
        if (val && !activeKeywords.includes(val)) {
            activeKeywords.push(val);
            renderKeywordTags();
            input.value = "";
        }
    }

    document.getElementById("new_kw_input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") addKeywordTag();
    });

    function removeKeywordTag(index) {
        activeKeywords.splice(index, 1);
        renderKeywordTags();
    }

    async function saveServerKeywords() {
        const status = document.getElementById("save-status");
        try {
            const res = await fetch(`${API_BASE}/keywords`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keywords: activeKeywords })
            });
            if (res.ok) {
                status.textContent = "âœ… è¨­å®šå„²å­˜æˆåŠŸï¼æ­£åœ¨å•Ÿå‹•èƒŒæ™¯æƒæ...";
                status.style.color = "green";
                setTimeout(() => { status.textContent = ""; loadNotifications(); }, 5000);
            }
        } catch (e) { status.textContent = "âŒ å„²å­˜å¤±æ•—"; status.style.color = "red"; }
    }

    // --- é€šçŸ¥èˆ‡æŸ¥è©¢ ---
    async function loadNotifications() {
        try {
            const res = await fetch(`${API_BASE}/notifications`);
            const alerts = await res.json();
            const notifDiv = document.getElementById("notification-list");
            const notifSection = document.getElementById("notif-section");

            if (alerts && alerts.length > 0) {
                notifSection.style.display = "block";
                notifDiv.innerHTML = alerts.map((a, index) => `
                    <div class="notification-item-container" style="border-bottom: 1px solid #eee;">
                        <div class="notification-item" onclick="toggleNotifContent(${index})" style="cursor: pointer; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span class="notif-tag">${a.matched_keyword}</span>
                                <strong>${a.company_name}</strong> (${a.company_code}) 
                                <br><span style="font-size: 14px; color: #555;">${a.subject}</span>
                            </div>
                            <div style="text-align: right; min-width: 150px;">
                                <small style="color: #888;">${a.publish_date} ${a.publish_time}</small>
                                <div style="font-size: 12px; color: #007bff; margin-top: 4px;">â–¼ é»æ“ŠæŸ¥çœ‹å…§æ–‡</div>
                            </div>
                        </div>
                        <div id="notif-content-${index}" style="display: none; padding: 15px; background: #fff; font-size: 14px; line-height: 1.6; border-top: 1px dashed #ddd; white-space: pre-wrap; color: #333;">
                            ${a.content || 'ç„¡å…§æ–‡è³‡æ–™'}
                        </div>
                    </div>
                `).join('');
            } else {
                notifSection.style.display = "none";
            }
        } catch (e) { console.error("ç„¡æ³•è¼‰å…¥é€šçŸ¥åˆ—è¡¨", e); }
    }

    function toggleNotifContent(index) {
        const contentDiv = document.getElementById(`notif-content-${index}`);
        contentDiv.style.display = contentDiv.style.display === "none" ? "block" : "none";
    }

    async function clearNotifications() {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å‘½ä¸­é€šçŸ¥ç´€éŒ„å—ï¼Ÿ")) return;
        try {
            const res = await fetch(`${API_BASE}/notifications`, { method: "DELETE" });
            if (res.ok) {
                document.getElementById("notif-section").style.display = "none";
                document.getElementById("notification-list").innerHTML = "";
            }
        } catch (e) { alert("æ¸…é™¤å¤±æ•—"); }
    }

    async function fetchData() {
        const start = document.getElementById("start_date").value;
        const end = document.getElementById("end_date").value;
        const company = document.getElementById("search_company").value;
        const keyword = document.getElementById("search_keyword").value;

        let url = `${API_BASE}/filter?start_date=${start}&end_date=${end}` + 
                `&company=${encodeURIComponent(company)}` + 
                `&keyword=${encodeURIComponent(keyword)}`;

        try {
            const res = await fetch(url);
            currentData = await res.json();
            const tbody = document.querySelector("#results tbody");
            tbody.innerHTML = "";

            currentData.forEach(r => {
                const tr = document.createElement("tr");
                const contentCell = document.createElement("td");
                contentCell.className = "content-cell";
                contentCell.textContent = "å±•é–‹å…§æ–‡";
                contentCell.onclick = () => {
                    if (contentCell.classList.contains("expanded")) {
                        contentCell.classList.remove("expanded");
                        contentCell.textContent = "å±•é–‹å…§æ–‡";
                    } else {
                        contentCell.classList.add("expanded");
                        contentCell.textContent = r.content || "ç„¡å…§å®¹";
                    }
                };
                tr.innerHTML = `
                    <td>${r.market}</td>
                    <td>${r.company_code}<br>${r.company_name}</td>
                    <td>${r.publish_date}<br>${r.publish_time}</td>
                    <td>${r.subject}</td>
                `;
                tr.appendChild(contentCell);
                tbody.appendChild(tr);
            });
            document.getElementById("exportBtn").style.display = currentData.length > 0 ? "inline-block" : "none";
        } catch (e) { alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é€£ç·š"); }
    }

    function exportToCSV() {
        const headers = ["å¸‚å ´", "å…¬å¸ä»£è™Ÿ", "å…¬å¸åç¨±", "ç™¼è¨€æ—¥æœŸ", "ç™¼è¨€æ™‚é–“", "ä¸»æ—¨", "å…§æ–‡"];
        const rows = currentData.map(r => [
            r.market, r.company_code, r.company_name, r.publish_date, r.publish_time,
            `"${(r.subject || "").replace(/"/g, '""')}"`,
            `"${(r.content || "").replace(/"/g, '""')}"`
        ].join(","));
        const csvContent = "\uFEFF" + [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `mops_export.csv`;
        link.click();
    }
</script>
</body>
</html>