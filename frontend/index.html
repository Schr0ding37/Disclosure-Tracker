<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é‡å¤§è¨Šæ¯ç›£æ§ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: auto; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2, h3 { color: #333; border-left: 5px solid #007bff; padding-left: 10px; }
        
        /* é€šçŸ¥åˆ—è¡¨æ¨£å¼ */
        #notif-section { border: 2px solid #ff4d4d; background-color: #fff9f9; }
        #notification-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .notification-item { 
            background: #fff; border-bottom: 1px solid #ffebeb; 
            padding: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .notif-tag { background: #ff4d4d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px; font-weight: bold; }

        /* è¨­å®šèˆ‡æŸ¥è©¢å€ */
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        input[type="text"], input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-query { background-color: #007bff; }
        .btn-export { background-color: #28a745; }
        .btn-save { background-color: #6c757d; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f1f3f5; }
        td.content-cell { cursor: pointer; color: #007bff; text-decoration: underline; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        td.content-cell.expanded { white-space: normal; color: black; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ˆ è‚¡å¸‚é‡å¤§è¨Šæ¯ä¸»å‹•ç›£æ§ç³»çµ±</h2>

    <div id="notif-section" class="section" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ”” é—œéµå­—å‘½ä¸­é€šçŸ¥ (æœ€æ–° 20 ç­†)</h3>
            <button class="btn" style="background-color: #dc3545; font-size: 12px;" onclick="clearNotifications()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰é€šçŸ¥</button>
        </div>
        <div id="notification-list"></div>
    </div>

    <div class="section">
        <h3>ğŸ› ï¸ ç›£æ§æ¸…å–®è¨­å®š</h3>
        <div class="controls">
            <input type="text" id="server_keywords" placeholder="è¼¸å…¥é—œéµå­—ï¼Œç”¨é€—è™Ÿéš”é–‹ (å¦‚: æ¸›è³‡, ä½µè³¼)" style="width: 500px;">
            <button class="btn btn-save" onclick="saveServerKeywords()">æ›´æ–°ç›£æ§æ¸…å–®</button>
            <span id="save-status"></span>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ” æ­·å²è³‡æ–™æŸ¥è©¢</h3>
        <div class="controls">
            <label>æ—¥æœŸ: <input type="date" id="start_date"> ~ <input type="date" id="end_date"></label>
            <input type="text" id="keyword" placeholder="æœå°‹ä¸»æ—¨...">
            <button class="btn btn-query" onclick="fetchData()">æŸ¥è©¢</button>
            <button id="exportBtn" class="btn btn-export" style="display:none;" onclick="exportToCSV()">åŒ¯å‡º CSV</button>
        </div>

        <table id="results">
            <thead>
                <tr>
                    <th>å¸‚å ´</th>
                    <th>å…¬å¸</th>
                    <th>æ—¥æœŸæ™‚é–“</th>
                    <th>ä¸»æ—¨</th>
                    <th>å…§æ–‡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let currentData = [];
    
    // ã€é—œéµä¿®æ”¹ã€‘è‡ªå‹•åµæ¸¬ç•¶å‰ IP
    const currentHost = window.location.hostname;
    const API_BASE = `http://${currentHost}:8000`;

    window.onload = () => {
        // è¨­å®šé è¨­æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("start_date").value = today;
        document.getElementById("end_date").value = today;

        // åˆå§‹åŒ–ï¼šè¼‰å…¥é—œéµå­—èˆ‡é€šçŸ¥
        loadServerKeywords();
        loadNotifications();
    };

    // --- é—œéµå­—ç®¡ç† ---
    async function loadServerKeywords() {
        try {
            // ä½¿ç”¨ API_BASE ä»£æ›¿ localhost
            const res = await fetch(`${API_BASE}/keywords`);
            const data = await res.json();
            if (data.keywords) {
                document.getElementById("server_keywords").value = data.keywords.join(", ");
            }
        } catch (e) { console.error("ç„¡æ³•è¼‰å…¥é—œéµå­—"); }
    }

    // ã€æ–°å¢ã€‘æ¸…é™¤é€šçŸ¥çš„é‚è¼¯
    async function clearNotifications() {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å‘½ä¸­é€šçŸ¥ç´€éŒ„å—ï¼Ÿ")) return;

        try {
            const res = await fetch(`${API_BASE}/notifications`, {
                method: "DELETE"
            });
            if (res.ok) {
                // æ¸…é™¤æˆåŠŸå¾Œï¼Œéš±è—é€šçŸ¥å€å¡Šä¸¦æ¸…ç©ºåˆ—è¡¨
                document.getElementById("notif-section").style.display = "none";
                document.getElementById("notification-list").innerHTML = "";
            }
        } catch (e) {
            alert("æ¸…é™¤å¤±æ•—");
        }
    }
    // ä¿®æ”¹åŸæœ‰çš„ saveServerKeywords æç¤ºæ–‡å­—
    async function saveServerKeywords() {
        const kwInput = document.getElementById("server_keywords").value;
        const kwArray = kwInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
        
        try {
            const res = await fetch(`${API_BASE}/keywords`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ keywords: kwArray })
            });
            if (res.ok) {
                const status = document.getElementById("save-status");
                status.textContent = "âœ… æ›´æ–°æˆåŠŸï¼Œå·²å•Ÿå‹•èƒŒæ™¯æƒæ...";
                status.style.color = "green";
                setTimeout(() => status.textContent = "", 5000);
                
                // é¸åšï¼š5 ç§’å¾Œè‡ªå‹•åˆ·æ–°é€šçŸ¥åˆ—è¡¨ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰æ–°å‘½ä¸­
                setTimeout(loadNotifications, 5000);
            }
        } catch (e) { alert("å„²å­˜å¤±æ•—"); }
    }

    // --- é€šçŸ¥åˆ—è¡¨ï¼šå‘å¾Œç«¯ API è«‹æ±‚å‘½ä¸­ç´€éŒ„ ---
    async function loadNotifications() {
        try {
            const res = await fetch(`${API_BASE}/notifications`);
            const alerts = await res.json();
            const notifDiv = document.getElementById("notification-list");
            const notifSection = document.getElementById("notif-section");

            if (alerts && alerts.length > 0) {
                notifSection.style.display = "block"; // æœ‰è³‡æ–™æ‰é¡¯ç¤ºç´…æ¡†å€å¡Š
                notifDiv.innerHTML = alerts.map(a => `
                    <div class="notification-item">
                        <div>
                            <span class="notif-tag">${a.matched_keyword}</span>
                            <strong>${a.company_name}</strong>: ${a.subject}
                        </div>
                        <small>${a.publish_date} ${a.publish_time}</small>
                    </div>
                `).join('');
            } else {
                notifSection.style.display = "none";
            }
        } catch (e) { 
            console.error("ç„¡æ³•è¼‰å…¥é€šçŸ¥åˆ—è¡¨", e); 
        }
    }

    // --- æŸ¥è©¢åŠŸèƒ½ ---
    async function fetchData() {
        const start = document.getElementById("start_date").value;
        const end = document.getElementById("end_date").value;
        const keyword = document.getElementById("keyword").value;
        // ä½¿ç”¨ API_BASE ä»£æ›¿ localhost
        let url = `${API_BASE}/filter?start_date=${start}&end_date=${end}&keyword=${encodeURIComponent(keyword)}`;
        const res = await fetch(url);
        currentData = await res.json();
        const tbody = document.querySelector("#results tbody");
        tbody.innerHTML = "";

        currentData.forEach(r => {
            const tr = document.createElement("tr");
            const contentCell = document.createElement("td");
            contentCell.className = "content-cell";
            contentCell.textContent = "å±•é–‹å…§æ–‡";
            contentCell.onclick = () => {
                if (contentCell.classList.contains("expanded")) {
                    contentCell.classList.remove("expanded");
                    contentCell.textContent = "å±•é–‹å…§æ–‡";
                } else {
                    contentCell.classList.add("expanded");
                    contentCell.textContent = r.content || "ç„¡å…§å®¹";
                }
            };

            tr.innerHTML = `
                <td>${r.market}</td>
                <td>${r.company_code}<br>${r.company_name}</td>
                <td>${r.publish_date}<br>${r.publish_time}</td>
                <td>${r.subject}</td>
            `;
            tr.appendChild(contentCell);
            tbody.appendChild(tr);
        });
        document.getElementById("exportBtn").style.display = currentData.length > 0 ? "inline-block" : "none";
    }

    function exportToCSV() {
        const headers = ["å¸‚å ´", "å…¬å¸ä»£è™Ÿ", "å…¬å¸åç¨±", "ç™¼è¨€æ—¥æœŸ", "ç™¼è¨€æ™‚é–“", "ä¸»æ—¨", "å…§æ–‡"];
        const rows = currentData.map(r => [
            r.market, r.company_code, r.company_name, r.publish_date, r.publish_time,
            `"${(r.subject || "").replace(/"/g, '""')}"`,
            `"${(r.content || "").replace(/"/g, '""')}"`
        ].join(","));
        const csvContent = "\uFEFF" + [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `mops_export.csv`;
        link.click();
    }
</script>
</body>
</html>