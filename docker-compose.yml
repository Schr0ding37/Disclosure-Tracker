version: "3.9"

services:
  db:
    image: postgres:15-alpine
    container_name: mops-db
    restart: always
    environment:
      POSTGRES_DB: mops
      POSTGRES_USER: mops
      POSTGRES_PASSWORD: mops123
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"

  backend:
    build: ./backend
    image: mops-project-backend:latest  # 新增這一行
    container_name: major_backend
    restart: unless-stopped
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql://mops:mops123@db:5432/mops
    volumes:
      - ./fetcher:/app/fetcher
      - ./keywords.txt:/app/keywords.txt:rw
      - ./backfill.log:/app/backfill.log:rw  # 保留掛載，讓 API 讀取給前端看
    ports:
      - "8000:8000"
    command: >
      sh -c "
      until python3 -c 'import socket; s = socket.socket(); s.connect((\"db\", 5432))' 2>/dev/null; do
        echo 'Waiting for database...' && sleep 2
      done &&
      echo '1. 資料庫就緒，執行當日抓取...' &&
      python3 /app/fetcher/fetch_daily.py && 
      echo '2. 啟動 API 伺服器...' &&
      uvicorn main:app --host 0.0.0.0 --port 8000"

  frontend:
    image: nginx:alpine
    container_name: major_frontend
    restart: unless-stopped
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    ports:
      - "8080:80"

  scheduler:
    image: mcuadros/ofelia:latest
    container_name: mops_scheduler
    restart: unless-stopped
    depends_on:
      - backend
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: daemon --docker 
    labels:
      ofelia.job-exec.mops_fetch_job.schedule: "0 0 14,22 * * *"
      ofelia.job-exec.mops_fetch_job.container: "major_backend"
      ofelia.job-exec.mops_fetch_job.command: "python3 /app/fetcher/fetch_daily.py"