# 📊 重訊監控與資安事件追蹤系統 - 技術文件

本系統由 **當日監控服務 (Daily Tracker)** 與 **歷史回補服務 (Backfill Worker)** 雙軌組成，專為自動化採集「公開資訊觀測站 (MOPS)」重大訊息而設計，並整合關鍵字過濾與資料庫持久化儲存。

---

## 🏗️ 系統架構圖 (Architecture)

系統採用 Docker 容器化部署，區分為核心服務群與回補工作節點：

* **mops-db**: PostgreSQL 15 核心資料庫。
* **major_backend**: 提供 FastAPI 接口，並負責每日兩次的定時抓取工作 (`fetch_daily.py`)。
* **major_frontend**: Nginx 驅動的 Web 介面。
* **backfill_worker**: 獨立的高負載工作容器，負責解析與補齊過往年份的歷史數據 (`backfill_history.py`)。



---

## 🔍 核心邏輯演算法

### 1. 列表解析精準化 (BS4 + Regex)
針對 MOPS 混亂的 HTML 結構，系統捨棄了純 Regex 解析，改採 **BeautifulSoup 節點定位**。
* **定位邏輯**：搜尋所有標記為 `odd` 與 `even` 的 `<tr>` 資料列。
* **參數提取**：從「詳細資料」按鈕的 `onclick` 屬性中，使用 Regex 抓取 `seq_no`, `spoke_time`, `spoke_date`, `co_id`, `TYPEK` 五大關鍵參數。

### 2. 資料格式標準化 (Normalization)
系統會自動將非標準格式轉換為 SQL 友善格式：
* **日期轉換 ($ROC \rightarrow AD$)**: 將民國日期 `1150115` 或西元 `20260115` 統一轉換為 `YYYY-MM-DD`。
    - 公式：$Year_{AD} = Year_{ROC} + 1911$。
* **時間正規化**: 將不定長度的語音時間 `85759` 補零並格式化為 `08:57:59`。

### 3. 進度續傳機制 (Checkpoint)
`backfill_history.py` 具備狀態保存功能。系統會將目前處理的「年、月、市場索引、分頁」存入 `progress.json`。
> **優點**：若因網路中斷或封鎖導致容器重啟，系統會自動讀取 JSON 檔案，從斷點處繼續工作，不重複抓取。

---

## 🛠️ 部署與環境配置

### 環境變數 (Environment Variables)
| 變數名稱 | 範例值 | 說明 |
| :--- | :--- | :--- |
| `DATABASE_URL` | `postgresql://user:pw@db:5432/mops` | 資料庫連線字串 |
| `BACKFILL_TARGET_YEAR` | `114` | 歷史回補的目標年份 (民國) |

---

## 📊 資料庫 Schema 摘要

### 1. `disclosures` 表 (重大訊息主表)
儲存所有從 MOPS 抓取的原始公告資料。

| 欄位名稱 | 類型 | 說明 |
| :--- | :--- | :--- |
| `market` | VARCHAR | 市場別 (上市、上櫃、興櫃) |
| `company_code` | VARCHAR | 公司股票代號 (如: 2330) |
| `company_name` | VARCHAR | 公司名稱 (如: 台積電) |
| `publish_date` | DATE | 發布日期 (已轉換為西元 YYYY-MM-DD) |
| `publish_time` | TIME | 發布時間 (正規化為 HH:MM:SS) |
| `subject` | TEXT | 公告主旨 (重要搜尋欄位) |
| `content` | TEXT | 公告詳細說明內容 |
| `fetch_status` | BOOLEAN | 抓取狀態 (TRUE=成功, FALSE=待處理) |

> **資料完整性**：
> 設有 `UNIQUE (company_code, publish_date, publish_time, subject)` 複合唯一鍵，確保同一間公司在同一時間發布的同標題公告不會重複存入，這讓歷史回補與每日抓取可以併行而不衝突。

---

### 2. `alerts` 表 (關鍵字觸發通知)
當公告內容命中 `keywords.txt` 中的詞彙時，會自動關聯至此表。

| 欄位名稱 | 類型 | 說明 |
| :--- | :--- | :--- |
| `disclosure_id` | INTEGER | 關聯至 `disclosures` 的 ID (連動刪除) |
| `matched_keyword` | VARCHAR | 命中的關鍵字 (如：駭客、減資) |
| `created_at` | TIMESTAMP | 警報觸發時間 |

---

### ⚡ 效能優化 (Index)
為了支援前端快速搜尋與後端高效回補，系統建立了以下索引：
1. **日期索引 (`idx_publish_date`)**：對日期進行降序排列，確保「最新消息」秒開。
2. **待抓取索引 (`idx_fetch_status`)**：僅針對 `fetch_status = FALSE` 的資料建立部分索引，加速背景補件程序。
3. **公司搜尋索引 (`idx_company_search`)**：針對代號與名稱進行優化，支援快速過濾特定公司。



---
*文件最後更新時間：2026-01-15 10:45*